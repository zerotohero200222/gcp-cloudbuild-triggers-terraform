steps:
  # Step 1: Terraform Init
  - name: hashicorp/terraform:1.5.0
    id: Terraform Init
    entrypoint: sh
    args:
      - -c
      - |
        terraform init -input=false

  # Step 2: Terraform Format Check
  - name: hashicorp/terraform:1.5.0
    id: Terraform Format
    entrypoint: sh
    args:
      - -c
      - |
        terraform fmt -check -recursive

  # Step 3: Terraform Validate
  - name: hashicorp/terraform:1.5.0
    id: Terraform Validate
    entrypoint: sh
    args:
      - -c
      - |
        terraform validate

  # Step 4: Terraform Plan
  - name: hashicorp/terraform:1.5.0
    id: Terraform Plan
    entrypoint: sh
    args:
      - -c
      - |
        terraform plan \
          -input=false \
          -var-file="environments/${_ENV}.tfvars" \
          -out=tfplan
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“‹ Terraform Plan Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        terraform show -no-color tfplan | head -50

  # Step 5: Terraform Apply (only on main branch)
  - name: hashicorp/terraform:1.5.0
    id: Terraform Apply
    entrypoint: sh
    args:
      - -c
      - |
        if [ "${BRANCH_NAME}" = "main" ]; then
          echo "ğŸš€ Applying Terraform changes..."
          terraform apply -input=false -auto-approve tfplan
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Deployment Outputs"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          terraform output
        else
          echo "âš ï¸  Not on main branch - skipping apply"
          echo "Branch: ${BRANCH_NAME}"
        fi

# Substitution variables
substitutions:
  _ENV: dev  # Default to dev environment

# Options
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_MEDIUM

# Timeout
timeout: 600s
